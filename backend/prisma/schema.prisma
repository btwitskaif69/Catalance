generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}


enum UserRole {
  CLIENT
  FREELANCER
  ADMIN
  PROJECT_MANAGER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING_APPROVAL
}

enum ProjectStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  AWAITING_PAYMENT
  COMPLETED
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum DisputeStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  fullName     String
  phoneNumber  String?
  passwordHash String
  role         UserRole   @default(FREELANCER)
  status       UserStatus @default(ACTIVE)
  bio          String?    @db.Text
  skills       String[]   @default([])
  hourlyRate   Decimal?   @db.Decimal(10, 2)
  resetPasswordToken   String?   @unique
  resetPasswordExpires DateTime?
  fcmToken     String?    // Firebase Cloud Messaging token for push notifications
  otpCode      String?
  otpExpires   DateTime?
  isVerified   Boolean    @default(false)
  suspendedAt  DateTime?  // Track when user was suspended for 90-day deletion countdown
  phone        String?    // Contact number
  avatar       String?    // Profile image URL
  
  // Extended Profile
  jobTitle     String?
  companyName  String?
  location     String?
  rating       Decimal?   @db.Decimal(3, 1) @default(0)
  reviewCount  Int        @default(0)
  
  // New Profile Fields
  experienceYears Int?    @default(0)
  workExperience  Json?   @default("[]")
  services        String[] @default([])
  
  // Social/Portfolio
  portfolio    String?
  linkedin     String?
  github       String?
  portfolioProjects Json?    @default("[]")
  resume       String?


  ownedProjects Project[] @relation("ProjectOwner")
  managedProjects Project[] @relation("ProjectManager")
  proposals    Proposal[]
  createdChats ChatConversation[] @relation("ChatCreator")
  sentMessages ChatMessage[]      @relation("ChatSender")
  raisedDisputes Dispute[] @relation("DisputeRaiser")
  managedDisputes Dispute[] @relation("DisputeManager")

  notifications Notification[]
  availabilitySlots ManagerAvailability[] @relation("ManagerAvailability")
  bookedAppointments Appointment[] @relation("AppointmentBooker")
  managedAppointments Appointment[] @relation("AppointmentManager")
  payments Payment[] @relation("FreelancerPayments")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Project {
  id              String        @id @default(cuid())
  title           String
  description     String        @db.Text
  budget          Int?
  status          ProjectStatus @default(DRAFT)
  progress        Int           @default(0)
  spent           Int           @default(0)
  completedTasks  Json          @default("[]")
  verifiedTasks   Json          @default("[]")
  notes           String?       @db.Text
  owner           User          @relation("ProjectOwner", fields: [ownerId], references: [id])
  ownerId         String
  manager         User?         @relation("ProjectManager", fields: [managerId], references: [id])
  managerId       String?

  proposals       Proposal[]
  disputes        Dispute[]
  appointments    Appointment[]
  payments        Payment[]
  externalLink    String?       // Project link (e.g. markify.io)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model Proposal {
  id           String         @id @default(cuid())
  coverLetter  String         @db.Text
  amount       Int
  status       ProposalStatus @default(PENDING)
  budgetReminderSent Boolean  @default(false)
  freelancer   User           @relation(fields: [freelancerId], references: [id])
  freelancerId String
  project      Project        @relation(fields: [projectId], references: [id])
  projectId    String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Dispute {
  id              String        @id @default(cuid())
  description     String        @db.Text
  status          DisputeStatus @default(OPEN)
  resolutionNotes String?       @db.Text
  meetingLink     String?
  meetingDate     DateTime?
  meetingReminderSent Boolean @default(false)
  
  projectId       String
  project         Project       @relation(fields: [projectId], references: [id])
  
  raisedById      String
  raisedBy        User          @relation("DisputeRaiser", fields: [raisedById], references: [id])
  
  managerId       String?
  manager         User?         @relation("DisputeManager", fields: [managerId], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model Profile {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  services       String[] @default([])
  skills         Json?
  workExperience Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ChatConversation {
  id          String        @id @default(cuid())
  service     String?
  projectTitle String?
  createdBy   User?         @relation("ChatCreator", fields: [createdById], references: [id])
  createdById String?
  messages    ChatMessage[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model ChatMessage {
  id              String           @id @default(cuid())
  conversation    ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId  String
  sender          User?            @relation("ChatSender", fields: [senderId], references: [id])
  senderId        String?
  senderName      String?
  senderRole      String?
  role            String           @default("user")
  content         String?          @db.Text
  attachment      Json?            // store { name, size, type, url? }
  deleted         Boolean          @default(false)
  readAt          DateTime?
  createdAt       DateTime         @default(now())
  @@index([conversationId, createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   @default("general")
  title     String
  message   String   @db.Text
  read      Boolean  @default(false)
  data      Json?    // Extra data like link, relatedId etc.
  createdAt DateTime @default(now())

  @@index([userId])
}

enum AppointmentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model ManagerAvailability {
  id          String   @id @default(cuid())
  managerId   String
  manager     User     @relation("ManagerAvailability", fields: [managerId], references: [id])
  date        DateTime @db.Date
  startHour   Int      // 0-23 (e.g., 10 for 10:00 AM)
  endHour     Int      // 0-23 (e.g., 11 for 11:00 AM)
  isBooked    Boolean  @default(false)
  isEnabled   Boolean  @default(true)
  remark      String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([managerId, date, startHour])
  @@index([managerId, date])
}

model Appointment {
  id              String            @id @default(cuid())
  title           String
  description     String?           @db.Text
  date            DateTime          @db.Date
  startHour       Int               // 0-23
  endHour         Int               // 0-23
  status          AppointmentStatus @default(PENDING)
  meetingLink     String?
  
  // Who booked the appointment
  bookedById      String
  bookedBy        User              @relation("AppointmentBooker", fields: [bookedById], references: [id])
  
  // Which manager's slot
  managerId       String
  manager         User              @relation("AppointmentManager", fields: [managerId], references: [id])
  
  // Optional: related project
  projectId       String?
  project         Project?          @relation(fields: [projectId], references: [id])
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([managerId, date])
  @@index([bookedById])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id               String        @id @default(cuid())
  amount           Int           // Total amount from client
  platformFee      Int           @default(0) // 30% platform fee
  freelancerAmount Int           // Amount after fee (70%)
  currency         String        @default("INR")
  status           PaymentStatus @default(PENDING)
  description      String?       @db.Text
  
  // Relations
  projectId        String
  project          Project       @relation(fields: [projectId], references: [id])
  
  freelancerId     String
  freelancer       User          @relation("FreelancerPayments", fields: [freelancerId], references: [id])
  
  // Timestamps
  paidAt           DateTime?     // When payment was released to freelancer
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  
  @@index([freelancerId])
  @@index([projectId])
}
